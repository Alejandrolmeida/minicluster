#!/usr/sbin/nft -f
# nftables firewall configuration for RPI-02 Gateway
# Minicluster - Gateway/NAT/Firewall
# Última actualización: Febrero 2026

# Limpiar todas las reglas existentes
# NOTA: flush ruleset está comentado para no borrar reglas de Tailscale (iptables-nft)
# flush ruleset

# Definir tabla inet (IPv4 + IPv6)
table inet filter {
    # Variables
    define LAN_IF = eth0
    define WAN_IF_PRIMARY = eth1
    define WAN_IF_BACKUP = wlan0
    define LAN_NET = 192.168.50.0/24

    # Chain para INPUT (tráfico hacia el gateway)
    chain input {
        type filter hook input priority 0; policy drop;

        # Aceptar tráfico de conexiones establecidas y relacionadas
        ct state established,related accept

        # Aceptar loopback
        iif lo accept

        # Aceptar ICMPv4 (ping, etc.)
        ip protocol icmp accept

        # Aceptar ICMPv6 (importante para IPv6)
        meta nfproto ipv6 icmpv6 type { 
            echo-request, 
            echo-reply, 
            nd-neighbor-solicit, 
            nd-neighbor-advert,
            nd-router-solicit,
            nd-router-advert 
        } accept

        # Aceptar SSH desde LAN y Tailscale
        iifname { $LAN_IF, "tailscale0" } tcp dport 22 accept

        # Aceptar SSH desde WAN (opcional - comentar si no se necesita)
        # iifname { $WAN_IF_PRIMARY, $WAN_IF_BACKUP } tcp dport 22 accept

        # Aceptar DNS desde LAN (dnsmasq)
        iifname $LAN_IF udp dport 53 accept
        iifname $LAN_IF tcp dport 53 accept

        # Aceptar DHCP desde LAN (dnsmasq)
        iifname $LAN_IF udp dport 67 accept

        # Aceptar Tailscale
        iifname "tailscale0" accept
        udp dport 41641 accept  # Puerto Tailscale

        # Log de paquetes descartados (opcional)
        # limit rate 5/minute log prefix "nft-input-drop: "

        # Rechazar todo lo demás
        reject
    }

    # Chain para FORWARD (tráfico que pasa por el gateway)
    chain forward {
        type filter hook forward priority 0; policy drop;

        # Aceptar tráfico de conexiones establecidas y relacionadas
        ct state established,related accept

        # Permitir tráfico desde LAN hacia WAN
        iifname $LAN_IF oifname { $WAN_IF_PRIMARY, $WAN_IF_BACKUP } accept

        # Permitir tráfico desde Tailscale hacia LAN
        iifname "tailscale0" oifname $LAN_IF ip daddr $LAN_NET accept

        # Permitir tráfico desde LAN hacia Tailscale
        iifname $LAN_IF oifname "tailscale0" accept

        # Log de paquetes descartados (opcional)
        # limit rate 5/minute log prefix "nft-forward-drop: "

        # Rechazar todo lo demás
        reject
    }

    # Chain para OUTPUT (tráfico desde el gateway)
    chain output {
        type filter hook output priority 0; policy accept;
    }
}

# Tabla para NAT
table ip nat {
    # Chain para NAT de salida (masquerade)
    chain postrouting {
        type nat hook postrouting priority 100; policy accept;

        # NAT para tráfico desde LAN hacia WAN
        # Masquerade dinámico (se adapta a cambios de IP en WAN)
        oifname { "eth1", "wlan0" } masquerade
    }

    # Chain para NAT de entrada (opcional - port forwarding)
    chain prerouting {
        type nat hook prerouting priority -100; policy accept;

        # Ejemplo: Redirigir puerto 8080 desde WAN al nodo rpi-03:80
        # iifname { "eth1", "wlan0" } tcp dport 8080 dnat to 192.168.50.10:80
    }
}
